
---
title: "Kalender"
format:
  html:
    toc: false
    include-in-header:
      - text: |
          <style>
            #calendar { max-width: 1200px; margin: 0 auto; }
          </style>
---

```{r}
library(readr)
library(dplyr)
library(lubridate)
library(jsonlite)

repo_b_dir <- Sys.getenv("REPO_B_DIR", unset = NA_character_)
if (is.na(repo_b_dir) || repo_b_dir == "") stop("REPO_B_DIR is not set")

bookings_path <- file.path(repo_b_dir, "data", "bookings.csv")

df <- read_csv(bookings_path, show_col_types = FALSE)

events <- df |>
  mutate(
    start = ymd_hms(fromDate, tz = "Europe/Copenhagen"),
    end   = ymd_hms(toDate,   tz = "Europe/Copenhagen"),
    title = paste0("lid=", lid, " · cid=", cid, " · eid=", eid)
  ) |>
  transmute(
    title = title,
    start = format(start, "%Y-%m-%dT%H:%M:%S"),
    end   = format(end,   "%Y-%m-%dT%H:%M:%S"),
    id    = bookId
  )

events_json <- toJSON(events, auto_unbox = TRUE, dataframe = "rows")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
cat('<script id="events-data" type="application/json">')
cat(events_json)
cat('</script>')
```

<div id="calendar"></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const el = document.getElementById('calendar');
  const raw = document.getElementById('events-data').textContent;
  const events = JSON.parse(raw);

  const cal = new FullCalendar.Calendar(el, {
    initialView: 'timeGridWeek',
    nowIndicator: true,
    firstDay: 1,
    height: "auto",
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    events: events
  });

  cal.render();
});
</script>